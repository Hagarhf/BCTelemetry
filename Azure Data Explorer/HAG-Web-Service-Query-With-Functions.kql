//================================================================
// HAG Web Service API - Dashboard Query with Function Names
//================================================================
// This query attempts to extract function/procedure names if available
//================================================================

let TimeRange = 24h;
traces
| where timestamp > ago(TimeRange)
| extend
    alObjectId = tostring(customDimensions.alObjectId),
    alObjectName = tostring(customDimensions.alObjectName),
    alObjectMethod = tostring(customDimensions.alObjectMethod),
    alMethodName = tostring(customDimensions.alMethodName),
    endpoint = tostring(customDimensions.endpoint),
    httpRoute = tostring(customDimensions.httpRoute)
| where alObjectId == "80107"
| extend
    // Try to get function name from various sources
    FunctionName = coalesce(
        alObjectMethod,
        alMethodName,
        endpoint,
        httpRoute,
        "Unknown"
    )
| extend executionTimeMs = toreal(totimespan(customDimensions.serverExecutionTime))/10000
| summarize
    CallCount = count(),
    AvgMs = round(avg(executionTimeMs), 2),
    P95Ms = round(percentile(executionTimeMs, 95), 2),
    MaxMs = round(max(executionTimeMs), 2),
    ErrorCount = countif(severityLevel >= 3),
    LastCall = max(timestamp)
    by bin(timestamp, 1h), FunctionName
| extend MinutesSinceLastCall = datetime_diff('minute', now(), LastCall)
| extend
    PerformanceStatus = case(
        AvgMs > 1000, "🔴 Slow (>1s)",
        AvgMs > 500, "⚠️ Moderate (500ms-1s)",
        "✅ Fast (<500ms)"
    ),
    HealthStatus = case(
        ErrorCount > 0, "🔴 Has Errors",
        MinutesSinceLastCall > 60, "⚠️ Inactive >1h",
        "✅ Healthy"
    )
| project
    timestamp,
    FunctionName,
    CallCount,
    AvgMs,
    P95Ms,
    MaxMs,
    ErrorCount,
    PerformanceStatus,
    HealthStatus,
    LastCall
| order by timestamp desc, CallCount desc;

//================================================================
// ALTERNATIVE: If function names are in custom dimensions
//================================================================
// If the diagnostic queries show function names in a custom field,
// use this pattern and replace 'YourCustomField' with the actual field name:
//
// | extend FunctionName = tostring(customDimensions.YourCustomField)
//
//================================================================

//================================================================
// ALTERNATIVE: Summary by Function (No Time Bins)
//================================================================
// If you want to see overall stats per function (not hourly):

/*
let TimeRange = 24h;
traces
| where timestamp > ago(TimeRange)
| extend
    alObjectId = tostring(customDimensions.alObjectId),
    alObjectMethod = tostring(customDimensions.alObjectMethod),
    alMethodName = tostring(customDimensions.alMethodName)
| where alObjectId == "80107"
| extend FunctionName = coalesce(alObjectMethod, alMethodName, "Unknown")
| extend executionTimeMs = toreal(totimespan(customDimensions.serverExecutionTime))/10000
| summarize
    CallCount = count(),
    AvgMs = round(avg(executionTimeMs), 2),
    P50Ms = round(percentile(executionTimeMs, 50), 2),
    P95Ms = round(percentile(executionTimeMs, 95), 2),
    MaxMs = round(max(executionTimeMs), 2),
    ErrorCount = countif(severityLevel >= 3),
    LastCall = max(timestamp)
    by FunctionName
| extend
    SuccessRate = round(100.0 - (toreal(ErrorCount) * 100.0 / toreal(CallCount)), 1),
    PerformanceStatus = case(
        AvgMs > 1000, "🔴 Slow (>1s)",
        AvgMs > 500, "⚠️ Moderate (500ms-1s)",
        "✅ Fast (<500ms)"
    )
| project
    FunctionName,
    CallCount,
    SuccessRate,
    AvgMs,
    P50Ms,
    P95Ms,
    MaxMs,
    ErrorCount,
    PerformanceStatus,
    LastCall
| order by CallCount desc;
*/
